<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>任务管理系统</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background: white;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			h1 {
				color: #333;
				text-align: center;
				margin-bottom: 30px;
			}
			.task-form {
				background: #f8f9fa;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 30px;
			}
			.task-list {
				background: #f8f9fa;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 30px;
			}
			.form-group {
				margin-bottom: 15px;
			}
			label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
				color: #555;
			}
			input[type="text"] {
				width: 100%;
				padding: 12px;
				border: 2px solid #ddd;
				border-radius: 5px;
				font-size: 16px;
				box-sizing: border-box;
			}
			input[type="text"]:focus {
				outline: none;
				border-color: #007bff;
			}
			button {
				background-color: #007bff;
				color: white;
				padding: 12px 24px;
				border: none;
				border-radius: 5px;
				font-size: 16px;
				cursor: pointer;
				transition: background-color 0.3s;
				margin-right: 10px;
				margin-bottom: 10px;
			}
			button:hover {
				background-color: #0056b3;
			}
			button:disabled {
				background-color: #6c757d;
				cursor: not-allowed;
			}
			button.secondary {
				background-color: #28a745;
			}
			button.secondary:hover {
				background-color: #218838;
			}
			.result {
				margin-top: 20px;
				padding: 15px;
				border-radius: 5px;
				display: none;
			}
			.success {
				background-color: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.error {
				background-color: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			.loading {
				text-align: center;
				color: #666;
			}
			.task-item {
				background: white;
				padding: 15px;
				margin-bottom: 10px;
				border-radius: 5px;
				border-left: 4px solid #007bff;
				box-shadow: 0 1px 3px rgba(0,0,0,0.1);
			}
			.task-item:last-child {
				margin-bottom: 0;
			}
			.task-name {
				font-weight: bold;
				color: #333;
				margin-bottom: 5px;
			}
			.task-meta {
				font-size: 14px;
				color: #666;
			}
			.task-id {
				background: #e9ecef;
				padding: 2px 6px;
				border-radius: 3px;
				font-family: monospace;
			}
			.task-time {
				margin-left: 10px;
			}
			.empty-state {
				text-align: center;
				color: #666;
				padding: 40px 20px;
				font-style: italic;
			}
			.refresh-btn {
				background-color: #17a2b8;
			}
			.refresh-btn:hover {
				background-color: #138496;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1 id="heading">任务管理系统</h1>
			<p>这是一个简单的任务管理系统，可以添加和管理日常任务。</p>
			
			<div class="task-form">
				<h3>添加新任务</h3>
				<form id="taskForm">
					<div class="form-group">
						<label for="taskName">任务名称:</label>
						<input type="text" id="taskName" name="name" placeholder="请输入任务名称" required>
					</div>
					<button type="submit" id="submitBtn">添加任务</button>
				</form>
				<div id="result" class="result"></div>
			</div>
			
			<div class="task-list">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
					<h3 style="margin: 0;">任务列表</h3>
					<button id="refreshBtn" class="refresh-btn">刷新列表</button>
				</div>
				<div id="taskListContainer">
					<div class="loading">正在加载任务列表...</div>
				</div>
			</div>
			
			<div>
				<h3>其他功能</h3>
				<button id="button" type="button">获取随机UUID</button>
				<output id="random" for="button"></output>
			</div>
		</div>

		<script>
			// 获取欢迎消息
			fetch('/message')
				.then((resp) => resp.text())
				.then((text) => {
					const h1 = document.getElementById('heading');
					h1.textContent = text;
				});

			// 加载任务列表
			async function loadTaskList() {
				const container = document.getElementById('taskListContainer');
				container.innerHTML = '<div class="loading">正在加载任务列表...</div>';
				
				try {
					const response = await fetch('/list/mission');
					if (response.ok) {
						const data = await response.json();
						displayTaskList(data.tasks);
					} else {
						container.innerHTML = '<div class="error">加载任务列表失败</div>';
					}
				} catch (error) {
					container.innerHTML = '<div class="error">网络错误: ' + error.message + '</div>';
				}
			}

			// 显示任务列表
			function displayTaskList(tasks) {
				const container = document.getElementById('taskListContainer');
				
				if (!tasks || tasks.length === 0) {
					container.innerHTML = '<div class="empty-state">暂无任务，请添加第一个任务吧！</div>';
					return;
				}
				
				const html = tasks.map(task => {
					const date = new Date(task.time * 1000);
					const timeString = date.toLocaleString('zh-CN', {
						year: 'numeric',
						month: '2-digit',
						day: '2-digit',
						hour: '2-digit',
						minute: '2-digit',
						second: '2-digit'
					});
					
					return `
						<div class="task-item">
							<div class="task-name">${escapeHtml(task.name)}</div>
							<div class="task-meta">
								<span class="task-id">ID: ${task.id}</span>
								<span class="task-time">创建时间: ${timeString}</span>
							</div>
						</div>
					`;
				}).join('');
				
				container.innerHTML = html;
			}

			// HTML转义函数
			function escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			// 处理任务表单提交
			document.getElementById('taskForm').addEventListener('submit', async function(e) {
				e.preventDefault();
				
				const taskName = document.getElementById('taskName').value.trim();
				const submitBtn = document.getElementById('submitBtn');
				const result = document.getElementById('result');
				
				if (!taskName) {
					showResult('请输入任务名称', 'error');
					return;
				}
				
				// 禁用按钮，显示加载状态
				submitBtn.disabled = true;
				submitBtn.textContent = '添加中...';
				showResult('正在添加任务...', 'loading');
				
				try {
					const formData = new FormData();
					formData.append('name', taskName);
					
					const response = await fetch('/add/mission', {
						method: 'POST',
						body: formData
					});
					
					if (response.ok) {
						const data = await response.json();
						showResult(`任务添加成功！ID: ${data.id}, 名称: ${data.name}`, 'success');
						document.getElementById('taskName').value = ''; // 清空输入框
						// 自动刷新任务列表
						loadTaskList();
					} else {
						const errorText = await response.text();
						showResult(`添加失败: ${errorText}`, 'error');
					}
				} catch (error) {
					showResult(`网络错误: ${error.message}`, 'error');
				} finally {
					// 恢复按钮状态
					submitBtn.disabled = false;
					submitBtn.textContent = '添加任务';
				}
			});
			
			// 显示结果消息
			function showResult(message, type) {
				const result = document.getElementById('result');
				result.textContent = message;
				result.className = `result ${type}`;
				result.style.display = 'block';
				
				// 3秒后自动隐藏成功消息
				if (type === 'success') {
					setTimeout(() => {
						result.style.display = 'none';
					}, 3000);
				}
			}

			// 刷新按钮事件
			document.getElementById('refreshBtn').addEventListener('click', loadTaskList);

			// 随机UUID功能
			const button = document.getElementById("button");
			button.addEventListener("click", () => {
				fetch('/random')
					.then((resp) => resp.text())
					.then((text) => {
						const random = document.getElementById('random');
						random.textContent = text;
					});
			});

			// 页面加载时自动加载任务列表
			loadTaskList();
		</script>
	</body>
</html>
